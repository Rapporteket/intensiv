---
title: "Intensivmedisin, Helse Nord"
author: "NiPaR v/Lena Ringstad Olsen"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(intensiv)
library(lubridate)
library(dplyr)
datoFra <- '2018-01-01'
datoTil <- '2020-12-31'
RegData <- NIRRegDataSQL(datoFra = datoFra, datoTil = datoTil)
query <- paste0('SELECT * FROM MainFormDataContract
WHERE cast(DateAdmittedIntensive as date) BETWEEN \'', datoFra, '\' AND \'', datoTil, '\'')
 
RegData <- rapbase::loadRegData(registryName="nir", query=query, dbType="mysql")

RegData <- RegData[RegData$RHF == 'Helse Nord', ]
RegData <- NIRPreprosess(RegData)
#RegData$Aar <- as.factor(RegData$Aar)
#Komplikasjoner:
RegData$KompTot <- (rowSums(RegData[ ,c('KompHypoglykemi',	'KompPneumotoraks',	'KompLuftveisproblem',
                              'KompDekubitus')])>0)
        grtxt <- c('Alvorlig hypoglykemi',	'Pneumotoraks',	'Luftveisproblem, \ntrakealtube/kanyle',
                   'Dekubitus', 'Minst én kompl.')

KjonnPst <- paste(sprintf('%.1f', prop.table(table(RegData$erMann))*100), '%')
N <- dim(RegData)[1]
under18 <- sprintf('%.1f', 100*sum(RegData$Alder<18)/N)
over80 <- sprintf('%.1f', 100*sum(RegData$Alder > 80)/N)
medAlder <- median(RegData$Alder, na.rm = T)
medLiggetid <- median(RegData$liggetid, na.rm = T)

respStotte <- sprintf('%.1f', 100*sum(RegData$MechanicalRespirator==1)/N)

iLiveUt <- sprintf('%.1f', 100*sum(RegData$DischargedIntensiveStatus==0)/N) #0: I live, 1: Død intensiv
iLive30d <- sprintf('%.1f', 100*sum(RegData$Dod30==0)/N)

        

alderDIV <- summary(RegData$Alder)[1:6]
names(alderDIV) <- c('Minimum:', '25% av pasientene er under:', 'Median:','Gjennsomsnitt:',
		'25% av pasientene er over:', 'Maksimum:')


# xtable(alderDIV, digits=1, align=c('l', rep('r', ncol(alderDIV))), 
# 		caption='Aldersfordeling (år)',
# 		label='tab:Alderskarakteristikker')


```

## Oversikt

For perioden 2018-19 var `r KjonnPst[1]` av intensivpasientane kvinner og `r KjonnPst[2]` menn. Median alder var `r medAlder`. Pasienter over 80 år stod for `r over80` \% av alle intensivopphold, og barn under 18 år stod for `r under18` \% av alle intensivopphold. Median liggjetid var `r medLiggetid` døger. Andel  pasienter som fekk respiratorstøtte var `r respStotte` \%. Ved `r iLiveUt` \% av oppholdene på intensiv ble pasientene utskrivne fra intensiv i live, og `r iLive30d` \% var i live 30 dagar etter innleggelse på intensiv. 

```{r Covid-pasienter, include=FALSE}
OpphCovRaa <- intensivberedskap::NIRberedskDataSQL(datoTil = '2020-12-31')
OpphCovRaa <- OpphCovRaa[OpphCovRaa$RHF == 'Helse Nord', ]
OpphCov <- intensivberedskap::NIRPreprosessBeredsk(OpphCovRaa, aggPers = 0)
#OpphCov <- OpphCov[OpphCov$RHF == 'Nord']
#OpphCovInt <- intensivberedskap::NIRberedskDataSQL(datoTil = '2020-12-31', kobleInt = 1)
#PasCov <- intensivberedskap::NIRPreprosessBeredsk(OpphCovRaa, aggPers = 1)

KjonnPstCov <- paste(sprintf('%.1f', prop.table(table(OpphCov$erMann))*100), '%')
N <- dim(OpphCov)[1]
medAlderCov <- round(median(OpphCov$Alder, na.rm = T), 1)
under18Cov <- sprintf('%.1f', 100*sum(OpphCov$Alder<18)/N)
over80Cov <- sprintf('%.1f', 100*sum(OpphCov$Alder > 80)/N)
medLiggetidCov <- round(median(OpphCov$Liggetid, na.rm = T), 1)

respStotte <- sprintf('%.1f', 100*sum(RegData$MechanicalRespirator==1)/N)


```


__Intensivopphold i 2020 hvor pasienten er innlagt med Covid-19__ \
For pasienter med covid-19 er det registrert `r dim(OpphCov)[1]` intensivopphold fordelt på `r length(unique(OpphCov$PersonId))` pasienter i 2020. Andel opphold med kvinneleg pasient var `r KjonnPstCov[1]` og del opphold med mannleg pasient var `r KjonnPstCov[2]`. 
Median alder var `r medAlderCov` år og median liggetid på intensiv var `r medLiggetidCov` døgn. For `r over80Cov` % av oppholdene var alder ved innlegging på intensiv 80 år eller høyere, mens alder var under 18 år i `r under18Cov` \% av oppholdene.\
\
_SMR, Helse-Nord sine avdelinger, tabell_ \
\


## Nøkkeltall
Oppsummeringstabell, Tab. 3.3, årsrapp 2020. \
Har lagt til andel opphold med komplikasjoner og 30-dagers dødelighet \
Lag tilsvarende for Helse Nord RHF, 2018-20 (år kommer som kolonner i samme tabell) \
Ønsker også per avdeling - det blir da en tabell for hver avdeling.

_Mekanisk ventilasjon_ = på respirator \
_Komplikasjoner_ \
Andel opphold med komplikasjon, er definert som et opphold hvor det her oppstått minst én av følgende komplikasjoner: \ 
Alvorlig hypoglykemi,	pneumotoraks,	luftveisproblem, trakealtube/kanyle, dekubitus \


```{r Nøkkeltall, echo=FALSE, results = 'asis'} 

tabNokkeltallNord <- function(RegData, sykehus)  {
  if (sykehus %in% unique(RegData$HelseenhetKortnavn)) {
    RegData <- RegData[RegData$HelseenhetKortnavn == sykehus, ]
  }
  
tabNokkeltallOrig <- tabNokkeltall(RegData=RegData, tidsenhet = 'Aar') #, tidsenhet='Mnd'
tabEkstra <- rbind(
  # 'Døde (%)' = tabNokkeltallOrig[12,],
  'Død innen 30 dager' = tapply(RegData$Dod30==1, RegData$Aar, 
       FUN=function(x) sum(x, na.rm=T)/length(x)*100),
  'Komplikasjoner (%)' = tapply(RegData$KompTot==1, RegData$Aar, 
       FUN=function(x) sum(x, na.rm=T)/length(x)*100)
  )
 tabNokkeltall <- rbind(
    tabNokkeltallOrig,
    tabEkstra
  )
kableExtra::kbl(tabNokkeltall,  digits= 1, #format='html', #align=c('l', rep('r', ncol(tabNokkeltall))), #row.names=F,
       caption = paste('Nøkkeltall for intensivopphold i ', sykehus))

}

sykehusnavn <- c('Helse Nord RHF',unique(RegData$HelseenhetKortnavn))

for (sykehus in sykehusnavn) {
 # print(paste0('<br /> ','__', sykehus, '__'))
   print('<br /> ')
  test <- tabNokkeltallNord(RegData=RegData, sykehus = sykehus)
  print(test)
}

digits <- rep(1,14)
digits[c(1:3,8,11)] <-0
#knitr::kable

```





